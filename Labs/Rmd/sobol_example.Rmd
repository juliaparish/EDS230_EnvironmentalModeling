---
title: "Sobol_Example"
author: "Julia Parish"
date: '2022-04-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sensitivity)
library(pse)
library(tidyverse)
library(gridExtra)
library(purrr)
library(ggpubr)
```

# Sobol in R

* *Sensitivity* package

* Sobol Indices require estimation - and there are different methods to do that

* The *Sensitivity* package has several of those

* today we will use *sobolSalt* - which uses a method by Saltelli (who has written extensively on Sensitivity analysis)

* R help pages for *Sensitivity* provide many good references

* This is a nice overview paper

[Variance Based Methods](https://www.sciencedirect.com/science/article/pii/S0010465509003087?casa_token=xG4MJV4hwJgAAAAA:Tq_CLHTqtM1wDvhzviZFgm6sVBdOoYzQdFfOGplEi5OUxLSWxaKITce-CzxLxfS6993rNnbK1Q)

# Sobol - how to

Similar workflow to LHS

* run Sobol to get parameter sets in a sensitivity analysis object
* run model with those parameter sets
* tell the senstivity object about results associated with each parameter set
* look at sensitivity analysis metric from Sobol

Generation of parameter sets slightly different

  * generate two samples of parameter sets by 
  samplng from apriori (expected) distributions
  * these would be the distributions you used for LHS

#  Example 

Atmospheric Conductance as a function of windspeed, vegetation height and parameters

```{r}
# atmcon function
source("../Labs/R/atmcon.R")
```

```{r}
# generate two examples of random number from parameter distributions
np=1000

k = rnorm(mean=0.1,sd=0.1*0.1, n=np)
kd = rnorm(mean=0.7, sd=0.7*0.1, n=np)
vm = rnorm(mean=200, sd=10, n=np)
h = runif(min=5, max=15, n=np)

X1 = cbind.data.frame(k, kd, vm, h=h)

# repeat sampling
k = rnorm(mean=0.1,sd=0.1*0.1, n=np)
kd = rnorm(mean=0.7, sd=0.7*0.1, n=np)
vm = rnorm(mean=200, sd=10, n=np)
h = runif(min=5, max=15, n=np)

X2 = cbind.data.frame(k, kd, vm, h=h)
```


```{r}
# there are different versions of sobol functions that have different approaches for estimating parameters and indices, we use an approach implemented by jansen 
sens_Catm_Sobol = sobolSalt(model = NULL, X1, X2, nboot = 100)
```


```{r}
# Take a look at the Sobol generated sensitivity object
# your parameters sets for sensitivity analysis are in X
# run model for all parameter sets
# make sure you give the parameters names
parms = as.data.frame(sens_Catm_Sobol$X)
colnames(parms) = colnames(X1)

# changed model from list to single result
model_output = pmap_dbl(parms, atmcon) # results

sens_Catm_Sobol = sensitivity::tell(sens_Catm_Sobol, model_output, model_output.names="ga")

# main effect:  partitions variance (main effect without co-variance) - sums approximately to one
sens_Catm_Sobol$S
```

```{r}
# useful to add names - if had to split variance in atmcon, about 73% is associated with height
# tells how variance can be 
row.names(sens_Catm_Sobol$S) = colnames(parms)
sens_Catm_Sobol$S
```

```{r}
# total effect - accounts for parameter interactions
row.names(sens_Catm_Sobol$T) = colnames(parms)
sens_Catm_Sobol$T
```


```{r}
# Both the main effect and total effect can tell us something about how the parameter influences results
print(sens_Catm_Sobol)
```


```{r}
# compare with LHS and PRCC; 
# sobol is computationally more complex, longer to calculate, variance based method - better analysis, more modern. 

sens_Catm_Sobol$S
```


```{r}
# compare with LHS and PRCC
sens_Catm_Sobol$T
```


```{r}
# make a data frame for plotting
both = cbind.data.frame(parms, gs=sens_Catm_Sobol$y)
```


```{r}
# look at response of conductance to the two most important variables
ggplot(both, aes(v,gs, col=height))+
  geom_point()+labs(y="Conductance (mm/s)", x="Windspeed")
```


```{r setsen, echo=TRUE, eval=TRUE}
source("../labs/R/Catm.R")
# names of our parameters
factors = c("mult_zo","mult_zd", "v","height")
# type of distributions they arise from
q = c("qnorm", "qunif", "qnorm","qnorm")

# parameters for those distributions
q.arg = list(list(mean=0.1,sd=0.01), list(min=0.6,max=0.8), list(mean=5, sd=1), 
             list(mean=20, sd=1))
nsets=200
sens_Catm = LHS(NULL,factors,nsets,q,q.arg, nboot=500)

# save parameter values
sens.pars = get.data(sens_Catm)
head(sens.pars)
```


```{r setsen, echo=TRUE, eval=TRUE}
ggplot(sens.pars, aes(mult_zo))+geom_density()
ggplot(sens.pars, aes(x=mult_zo, y=mult_zd))+geom_density_2d()
```


Now run the model - and give results to sensitivity analysis data structure generated by LHS 
* this allows us to take advantage of LHS functions for plotting and analysis

**tell**

provides the sensitivity structure created by LHS, results from model simulations

* can also provide names for results

We can then use two plotting commands

* **plotscatter**
  * given x-y plot of parameter and result
* **plotprcc**
  * Partial rank correlation coefficient 
* **plotecdf**
  * Cummulatative distribution of results - gives you range

```{r runsen, echo=TRUE, eval=TRUE}
# run the model
source("../Labs/R/Catm.R")


sens_res = Catm(v=sens.pars$v, height=sens.pars$height, zm=30, mult_zo=sens.pars$mult_zo, mult_zd=sens.pars$mult_zd)

sens_Catm = tell(sens_Catm, sens_res, res.names="ga")
plotscatter(sens_Catm)

# note it can take standard R plotting parameters
plotscatter(sens_Catm, col="darkgreen", cex=5, ylab="Atm Cond (mm/s)")

# whats is the range of results
plotecdf(sens_Catm, col="red", lwd=5, xlab="Atm Cond (mm/s)")

# we can also plot partial correlation coefficients
plotprcc(sens_Catm)
# and we can look at the actual values
# note because this is a linear model correlations are high for both parameters - and similar
```


```{r}
# compare with LHS and PRCC; if this is height, how much of the left over variance in windspeed
sens_Catm$prcc
```